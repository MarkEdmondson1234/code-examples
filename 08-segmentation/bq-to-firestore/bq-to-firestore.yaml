# iam roles: 
#  - bq job user
#  - bq data owner
#  - cloud datastore user
#  - logging admin
# workflows-bq-firestore@learning-ga4.iam.gserviceaccount.com
main:
    steps:
    - init:
        assign:
            - pageToken: null
            - bq_query: >
                SELECT A.name, A.crm_id, created, job,
                    sum(A.transactions) as sum_crm_trans, 
                    sum(A.revenue) as sum_crm_rev, 
                    sum(sum_web_trans) as sum_web_trans,
                    sum(sum_web_rev) as sum_web_rev,
                FROM (
                    (SELECT * FROM `learning-ga4.crm_imports.fake_crm_transactions`) AS A
                LEFT JOIN  
                    (SELECT user_pseudo_id,  
                            count(distinct ecommerce.transaction_id) as sum_web_trans,
                            sum(ecommerce.purchase_revenue_in_usd) as sum_web_rev,
                    FROM `learning-ga4.ga4_public_dataset.events_*`
                    GROUP BY 1) as B
                ON B.user_pseudo_id = A.cid)
                GROUP BY 1,2,3,4
            - projectId: ${sys.get_env("GOOGLE_CLOUD_PROJECT_ID")}
            - collection: "crm-import"
    - startQuery:
        call: googleapis.bigquery.v2.jobs.insert
        args:
            projectId: ${projectId}
            body:
                configuration:
                    query:
                        useLegacySql: false
                        maximumBytesBilled: 1000000000 # 10GB
                        query: ${bq_query}
        result: query
    - getPage:
        call: googleapis.bigquery.v2.jobs.getQueryResults
        args:
            projectId: ${projectId}
            jobId: ${query.jobReference.jobId}
            maxResults: 500
            pageToken: ${pageToken}
        result: page
    - extract_schema:
        call: extract_schema
        args:
            page: ${page}
        result: schema_names
    - log_schema:
        call: sys.log
        args:
            data: ${schema_names}
    - processPage:
        for:
          value: row
          in: ${page.rows}
          steps:
            - parse_data:
                call: map_bq_result
                args:
                    row: ${row}
                    names: ${schema_names}
                result: bq_map
            - list_to_dict:
                  call: list_to_dict
                  args:
                    a_list: ${bq_map}
                  result: bq_dict            
            - assign_row_values:
                assign: 
                    - values_to_write: ${bq_dict}
                    - document: ${bq_dict.crm_id.stringValue} # change to column holding firestore key
            - write_to_firestore:
                call: googleapis.firestore.v1.projects.databases.documents.patch
                args:
                    name: ${"projects/"+projectId+"/databases/(default)/documents/"+collection+"/"+document}
                    body:
                        fields: ${values_to_write}
                result: write_result
    - checkIfDone:
        switch:
            - condition: ${"pageToken" in page and page.pageToken != ""}
              assign:
                - pageToken: ${page.pageToken}
              next: getPage

extract_schema:
    params: [page]
    steps:
        - init_schema_list:
            assign:
                - schema_list: []
                - i: 0
                - array: ${page.schema.fields}
        - check_condition:
            switch:
                - condition: ${len(array) > i}
                  next: iterate
            next: exit_loop
        - iterate:
            assign:
              - value: ${array[i].name}
              - schema_list: ${list.concat(schema_list, value)}
              - i: ${i+1}
            next: check_condition
        - exit_loop:
            return: ${schema_list}

map_bq_result:
    params: [row, names]
    steps:
        - init_cell_list:
            assign:
                - cell_list: []
        - processRow: 
        # TODO: map different types to BigQuery schema
        # https://cloud.google.com/firestore/docs/reference/rest/Shared.Types/ArrayValue#Value
            for:
                value: cell
                in: ${row.f}
                index: i
                steps:
                - map_cell:
                    assign: 
                    - name: ${names[i]}
                    - value: ${default(cell.v, "")}
                    - cell: {"${name}" : { "stringValue": '${value}'}}
                    - cell_list: ${list.concat(cell_list, cell)}
        - returnRowList:
            return: ${cell_list}

list_to_dict:
    params: [a_list]
    steps:
      - init_dict: 
          assign:
            - the_dict: {}
      - loop_list:
          for:
              value: entry
              in: ${a_list}
              steps:
              - map_entry:
                  assign:
                  - the_name: ${keys(entry)[0]}
                  - the_value: ${entry[the_name]}
                  - the_dict[the_name]: ${the_value}   
      - return_dict:
          return: ${the_dict}
